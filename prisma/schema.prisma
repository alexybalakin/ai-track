generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  name         String?
  email        String   @unique
  passwordHash String
  avatarUrl    String?
  timezone     String   @default("UTC")
  createdAt    DateTime @default(now())

  ownedBoards Board[]       @relation("BoardOwner")
  memberships BoardMember[]
  tasks       Task[]        @relation("TaskAssignee")
  comments    Comment[]
}

model Board {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int      @default(0)
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner   User          @relation("BoardOwner", fields: [ownerId], references: [id])
  members BoardMember[]
  tasks   Task[]
  columns BoardColumn[]
}

model BoardColumn {
  id        String  @id @default(cuid())
  title     String
  color     String  @default("#3b82f6")
  order     Int     @default(0)
  aiEnabled Boolean @default(false)
  boardId   String

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks Task[]
}

model BoardMember {
  id      String @id @default(cuid())
  boardId String
  userId  String
  role    String @default("member")

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
}

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("todo")
  priority    String   @default("medium")
  order       Int      @default(0)

  boardId    String
  columnId   String?
  assigneeId String?

  aiState  String  @default("idle")
  aiResult String? @db.Text
  aiLog    String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board        Board          @relation(fields: [boardId], references: [id], onDelete: Cascade)
  column       BoardColumn?   @relation(fields: [columnId], references: [id])
  assignee     User?          @relation("TaskAssignee", fields: [assigneeId], references: [id])
  comments     Comment[]
  aiIterations AiIteration[]
}

model AiIteration {
  id        String   @id @default(cuid())
  number    Int
  result    String   @db.Text
  log       String?  @db.Text
  state     String   @default("succeeded")
  feedback  String?  @db.Text
  taskId    String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model Comment {
  id        String   @id @default(cuid())
  text      String   @db.Text
  taskId    String
  authorId  String
  createdAt DateTime @default(now())

  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id])
}
